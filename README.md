# Интеграция Ziina и Tilda

Это решение позволяет принимать платежи через Ziina на сайте Tilda, используя Vercel как промежуточный сервер.

## Структура
- `api/init-payment.js`: Принимает запрос от Tilda, создает платеж в Ziina и перенаправляет пользователя.
- `api/webhook.js`: Получает уведомление от Ziina об успешной оплате и обновляет статус заказа в Tilda.
- `utils/`: Вспомогательные функции для подписей и API.

## Предварительные требования
1. Аккаунт Ziina (API Key).
2. Аккаунт Vercel.
3. Сайт на Tilda (Business план для Custom Payment Gateway).

## Установка и Развертывание

### 1. Vercel
1. Установите Vercel CLI: `npm i -g vercel`
2. Войдите в аккаунт: `vercel login`
3. Разверните проект из этой папки: `vercel`
4. Скопируйте полученный домен (например, `https://my-ziina-tilda.vercel.app`).

### 2. Настройка переменных окружения (Vercel Environment Variables)
В настройках проекта на Vercel добавьте следующие переменные:

- `ZIINA_API_KEY`: Ваш API ключ от Ziina (Bearer token).
- `ZIINA_API_URL`: `https://api-v2.ziina.com/api`
- `TILDA_SECRET`: Придумайте секретный ключ (например, `mysecret123`). Он должен совпадать с тем, что вы укажете в Tilda.
- `BASE_URL`: Ваш домен Vercel без слеша в конце (например, `https://my-ziina-tilda.vercel.app`).
- `TILDA_CALLBACK_URL`: URL для уведомлений Tilda. Обычно это `https://forms.tildacdn.com/payment/custom/` или специфичный для вашего проекта. *Примечание: Если Tilda передает этот URL в запросе, код попытается использовать его, но лучше задать явно.*
- `SHOP_SUCCESS_URL` (Опционально): Ссылка на страницу "Спасибо" на вашем сайте Tilda.

### 3. Настройка Tilda
1. Перейдите в **Настройки сайта** -> **Платежные системы**.
2. Выберите **Custom Payment Gateway** (Универсальная платежная система).
3. В поле **Настройки шаблона** выберите "Новая платежная система (для разработчиков)".
4. Заполните поля:
   - **API URL**: `https://<ваш-vercel-домен>/api/init-payment`
   - **Метод передачи данных**: POST
   - **Секрет для подписи заказа**: Тот же, что в `TILDA_SECRET`.
5. **Сопоставление полей (Mapping)**:
   - `order_id` -> `orderid`
   - `amount` -> `amount`
   - `currency` -> `currency`
   - `signature` -> `signature`
6. **Правила подписи (Signature Rules)**:
   - Выберите **Собственные правила (Custom rules)**.
   - Строка подписи: `{{orderid}}{{amount}}{{secret}}` (без пробелов и разделителей).
   - Алгоритм хеширования: **SHA256**.
7. **Индикатор успешного платежа** (для уведомлений):
   - Tilda ожидает запрос на свой Notification URL. Наш сервер отправит его автоматически.
   - Убедитесь, что галочка "Отправлять данные для уведомлений" (или подобная) включена, если она есть.

## Тестирование
1. Создайте тестовый товар на Tilda (цена 1 AED).
2. Попробуйте оплатить.
3. Вы должны быть перенаправлены на страницу Ziina.
4. После оплаты вы вернетесь на страницу успеха.
5. Заказ в Tilda должен отметиться как оплаченный (проверьте раздел "Заявки").

## Безопасность
- Все данные о картах вводятся на стороне Ziina.
- Подписи Tilda проверяются (SHA256).
- Код соответствует требованиям PCI DSS (SAQ A), так как не обрабатывает карточные данные напрямую.
